<!DOCTYPE html>
<html
  x-data="app"
  x-init="initialize"
  :data-theme="darkTheme ? 'dark' : 'light'">

<head>
  <meta charset="UTF-8" />
  <title>Positron</title>
</head>

<body>

  <!-- Top nav -->
  <header>
    <nav class="container-fluid">
      <ul>
        <li>
          <span class="bigger">
            <img id="icon" @click="openExternal('https://github.com/agustinmista/positron')"/>
          </span>
        </li>
      </ul>
      <ul>
        <li>
          <button @click="$store.settingsModal.open()">
            Settings
          </button>
        </li>
        <li>
          <button @click="$store.aboutModal.open()">
            About
          </button>
        </li>
      </ul>
    </nav>
  </header>

  <!-- Main content -->
  <div class="container-fluid">
    <main class="container">

      <!-- Shortcuts -->

      <!-- Empty -->
      <article x-show="shortcuts.length === 0" x-transition>
        <span>
          It's lonely here. Try adding a new shortcut!
        </span>
      </article>

      <!-- Not empty -->
      <template x-for="shortcut in shortcuts" :key="shortcut.id">
        <article x-data="{ok: true}">
          <details>

            <!-- Header -->
            <summary>
              <input
                type="checkbox"
                role="switch"
                x-model="shortcut.enabled"
                :aria-invalid="!ok"
                @click="ok=await toggleShortcut(shortcut)">
              <span x-text="shortcut.name">
              </span>
              <span
                x-show="shortcut.acc"
                x-text="`(${shortcut.acc})`"
                :class.transition="!ok && 'attention'">
              </span>
            </summary>
            <br />

            <!-- Name/Accelerator -->
            <div class="grid">

              <!-- Name -->
              <label for="name">
                Name
                <input
                  type="text"
                  id="name"
                  x-model="shortcut.name"
                  :disabled="shortcut.enabled">
              </label>

              <!-- Accelerator -->
              <label for="accelerator">
                Accelerator
                <input
                  type="text"
                  id="accelerator"
                  x-model="shortcut.acc"
                  :disabled="shortcut.enabled"
                  :aria-invalid="!ok">
                <small x-show="!ok">
                  Accelerator is invalid or already in use
                </small>
              </label>
            </div>

            <!-- Method/Endpoint -->
            <div class="grid-1-4">

              <!-- Method -->
              <div class="grid-1-4-1">
                <label for="method">
                  Method
                  <select
                    id="method"
                    x-model="shortcut.params.method"
                    :disabled="shortcut.enabled">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                  </select>
                </label>
              </div>

              <!-- Endpoint -->
              <div class="grid-1-4-2">
                <label for="endpoint">
                  Endpoint
                  <input
                    type="text"
                    id="endpoint"
                    x-model="shortcut.params.endpoint"
                    :disabled="shortcut.enabled">
                </label>
              </div>
            </div>

            <!-- Request body key/value pairs  -->
            <label>Request data</label>

            <template x-for="[index, pair] in getRequestBodyEntries(shortcut)" :key="index">
              <div class="grid-2-2-1">

                <!-- Key -->
                <input
                  class="grid-2-2-1-1"
                  type="text"
                  id="request-key"
                  placeholder="Key"
                  x-model="pair.key"
                  :aria-invalid="!isValidRequestBodyEntryKey(shortcut, pair.key)"
                  :disabled="shortcut.enabled">

                <!-- Value -->
                <input
                  class="grid-2-2-1-2"
                  type="text"
                  id="request-value"
                  placeholder="Value"
                  x-model="pair.value"
                  :disabled="shortcut.enabled">

                <!-- Remove button -->
                <button
                  class="grid-2-2-1-3 darkred"
                  :disabled="shortcut.enabled"
                  @click="removeRequestBodyEntry(shortcut, index)">
                  Remove
                </button>

              </div>
            </template>

            <!-- Add new key pair button -->
            <button
              class="darkgreen"
              :disabled="shortcut.enabled"
              @click="createRequestBodyEntry(shortcut)">
              Add key/value pair
            </button>
            <br />

            <!-- Custom handler -->
            <label for="custom-handler">
              <input
                type="checkbox"
                role="switch"
                x-model="shortcut.handler.enabled"
                :disabled="shortcut.enabled"
                @click="toggleShortcutHandler(shortcut)">
              Send custom notification
              <textarea
                id="custom-handler"
                rows="5"
                x-show="shortcut.handler.enabled"
                x-model="shortcut.handler.code"
                :disabled="shortcut.enabled">
              </textarea>
            </label>
            <br />

            <!-- Trigger/Duplicate/Delete -->
            <div class="grid">
              <!-- Busy trigger -->
              <button
                x-data="busyButton"
                x-model="busy"
                :class="busy && 'secondary'"
                :aria-busy="busy"
                :disabled="busy"
                @click="busyWhile(() =>
                  triggerShortcut(shortcut).then(content =>
                    $store.responseModal.open(content)))">
                Trigger
              </button>
              <!-- Duplicate -->
              <button @click="duplicateShortcut(shortcut)">
                Duplicate
              </button>
              <!-- 2-step delete -->
              <button
                x-data="twoStepButton"
                x-text="waiting ? 'Confirm' : 'Delete'"
                :class="waiting && 'darkred'"
                @click="waitConfirmation(() =>
                  deleteShortcut(shortcut))">
              </button>
            </div>

          </details>
        </article>
      </template>

      <!-- Create new shortcut -->
      <button class="darkgreen" @click="createShortcut()">
        New shortcut
      </button>
    </main>
  </div>

  <!-- Modals -->

  <!-- Settings -->
  <dialog open x-cloak
    x-show="$store.settingsModal.isOpen"
    x-transition
    @close-modal="$store.settingsModal.close()"
    @keydown.escape.window="$dispatch('close-modal')">

    <article>
      <header>
        <span class="bigger">Settings</span>
      </header>

      <!-- Server settings -->
      <h4>Home Assistant server</h4>

      <!-- Protocol/Host -->
      <div class="grid-1-4">

        <!-- Protocol -->
        <div class="grid-1-4-1">
          <label for="protocol">
            Protocol
            <select id="protocol" x-model="server.protocol">
              <option value="http">HTTP</option>
              <option value="https">HTTPS</option>
            </select>
          </label>
        </div>

        <!-- Hostname -->
        <div class="grid-1-4-2">
          <label for="hostname">
            Hostname
            <input
              type="text"
              id="hostname"
              x-model="server.hostname">
          </label>
        </div>
      </div>

      <!-- Port -->
      <label for="port">
        Port
        <input
          type="text"
          id="port"
          x-model="server.port">
      </label>

      <!-- Token -->
      <label for="token">
        Long-lived access token
        <input
          type="text"
          id="token"
          x-model="server.token">
      </label>

      <!-- Appearence settings -->
      <h4>Appearence</h4>

      <label for="darkTheme">
        Dark theme
        <input
          type="checkbox"
          role="switch"
          name="darkTheme"
          x-model="darkTheme"
          @click="toggleDarkTheme()">
      </label>
      <br />

      <!-- User config file settings -->
      <h4>Configuration file</h4>

      <div class="grid">
        <button @click="initialize()">
          Reload
        </button>
        <button @click="openUserConfig()">
          Open
        </button>
      </div>
      <br />

      <label for="autoSave">
        Auto save
        <input
          type="checkbox"
          role="switch"
          name="autoSave"
          x-model="autoSave"
          @click="toggleAutoSave()">
      </label>
      <small>
        Runs on shortcut creation, deletion and toggle
      </small>

      <footer>
        <div class="grid">
        <button
          class="secondary"
          @click="$dispatch('close-modal')">
          Close without saving
        </button>
        <button
          class="darkgreen"
          @click="saveUserConfig().then($dispatch('close-modal'))">
          Save and close
        </button>
      </div>
      </footer>
    </article>
  </dialog>

  <!-- About -->
  <dialog open x-cloak
    x-show="$store.aboutModal.isOpen"
    x-transition
    @close-modal="$store.aboutModal.close()"
    @keydown.escape.window="$dispatch('close-modal')">
    <article>
      <header>
        <span class="bigger">About</span>
      </header>

      <img id="icon-bigger" />
      <br />
      <br />
      <p>
        Positron <span x-text="getAppVersion"></span><br />
        Create keyboard shortcuts for Home Assistant actions.
      </p>
      <p>
        For more information about this application contact:<br />
        Agustín Mista (agustin@mista.me)
      </p>
      <p>
        Useful links:<br />
        <div class="grid">
          <button
            class="secondary"
            @click="openExternal('https://github.com/agustinmista/positron')">
            Positron Webpage
          </button>
          <button
            class="secondary"
            @click="openExternal('https://github.com/agustinmista/positron/issues')">
            Report Issues
          </button>
          <button
            class="secondary"
            @click="openExternal('https://www.home-assistant.io')">
            Home Assistant
          </button>
        </div>
      </p>

      <footer>
        <button
          class="darkgreen"
          @click="$dispatch('close-modal')">
          Close
        </button>
      </footer>
    </article>
  </dialog>

  <!-- Response -->
  <dialog open x-cloak
    x-show="$store.responseModal.isOpen"
    x-transition
    @close-modal="$store.responseModal.close()"
    @keydown.escape.window="$dispatch('close-modal')">
    <article>
      <header>
        <span class="bigger">Response</span>
      </header>
      <span x-html="$store.responseModal.data"></span>
      <footer>
        <button
          class="darkgreen"
          @click="$dispatch('close-modal')">
          Close
        </button>
      </footer>
    </article>
  </dialog>

</body>

</html>