<!DOCTYPE html>
<html x-data="app" x-init="initialize" :data-theme="darkTheme ? 'dark' : 'light'">

<head>
  <meta charset="UTF-8" />
  <title>Positron</title>
</head>

<body>

  <!-- Top nav -->
  <header>
    <nav class="container-fluid">
      <ul>
        <li>
          <span class="bigger">
            <img id="icon" @click="openExternal('https://github.com/agustinmista/positron')" />
          </span>
        </li>
      </ul>
      <ul>
        <li>
          <button @click="$store.settingsModal.open()">
            Settings
          </button>
        </li>
        <li>
          <button @click="$store.aboutModal.open()">
            About
          </button>
        </li>
      </ul>
    </nav>
  </header>

  <!-- Main content -->
  <div class="container-fluid">
    <main class="container">

      <!-- Shortcuts -->

      <!-- Empty -->
      <article x-show="shortcuts.length === 0" x-transition>
        <span>It's lonely here. Try adding a new shortcut!</span>
      </article>

      <!-- Not empty -->
      <template x-for="(shortcut, shortcutIndex) in shortcuts" :key="shortcut.id">
        <article x-data="{status: true}">
          <details>

            <!-- Header -->
            <summary>
              <svg height="1em" width="1.5em" @click.prevent="status=await toggleShortcut(shortcut)">
                <circle cx="0.5em" cy="0.5em" r="0.5em" :fill="shortcut.enabled ? 'green' : status ? 'gray' : 'darkred'" />
              </svg>
              <span x-text="shortcut.name"></span>
              <span x-show="shortcut.acc" x-text="`(${shortcut.acc})`" :class.transition="!status && 'attention'"></span>
            </summary>
            <br />

            <!-- Name/Accelerator -->
            <div class="grid">
              <!-- Name -->
              <div>
                <label>Name</label>
                <input type="text" x-model="shortcut.name" :disabled="shortcut.enabled">
              </div>

              <!-- Accelerator -->
              <div>
                <label>Accelerator</label>
                <input type="text" x-model="shortcut.acc" :disabled="shortcut.enabled" :aria-invalid="!status" @input="status=true">
                <small x-show="!status">Accelerator is invalid or already in use</small>
              </div>
            </div>

            <!-- Method/Endpoint -->
            <div class="grid-1-4">

              <!-- Method -->
              <div class="grid-1-4-1">
                <label>Method</label>
                <select x-model="shortcut.params.method" :disabled="shortcut.enabled">
                  <option value="GET">GET</option>
                  <option value="POST">POST</option>
                </select>
              </div>

              <!-- Endpoint -->
              <div class="grid-1-4-2">
                <label>Endpoint</label>
                <input type="text" x-model="shortcut.params.endpoint" :disabled="shortcut.enabled">
              </div>
            </div>

            <!-- Request body key/value pairs  -->

            <!-- Header -->
            <div class="grid-2-2-1">
              <div class="grid-2-2-1-1">
                <label>Request body</label>
              </div>
              <div class="grid-2-2-1-3">
                <button class="darkgreen" :disabled="shortcut.enabled" data-tooltip="Add a new key/value pair" @click="createRequestBodyEntry(shortcut)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z" />
                  </svg>
                </button>
              </div>
            </div>

            <!-- Key/value pairs -->

            <!-- Empty -->
            <div x-show="!shortcut.params.body.length">
              <input disabled placeholder="Empty (press + to add a new key/value pair)"/>
              <br />
              <br />
            </div>

            <!-- Not empty -->
            <div x-show="shortcut.params.body.length">
              <template x-for="(pair, pairIndex) in shortcut.params.body" :key="pairIndex">
                <div class="grid-2-2-1">

                  <!-- Key -->
                  <input class="grid-2-2-1-1" type="text" placeholder="Key" x-model="pair.key" :aria-invalid="!pair.key || shortcut.params.body.filter(otherPair => otherPair.key === pair.key).length > 1" :disabled="shortcut.enabled">

                  <!-- Value -->
                  <input class="grid-2-2-1-2" type="text" placeholder="Value" x-model="pair.value" :disabled="shortcut.enabled">

                  <!-- Delete button -->
                  <button class="grid-2-2-1-3 darkred" :disabled="shortcut.enabled" @click="deleteRequestBodyEntry(shortcut, pairIndex)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                      <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                    </svg>
                  </button>

                </div>
              </template>

              <br />
            </div>

            <!-- Custom handler -->
            <label>
              <input type="checkbox" role="switch" x-model="shortcut.handler.enabled" :disabled="shortcut.enabled" @click="toggleShortcutHandler(shortcut)">
              Send custom notification
            </label>
            <br />
            <div x-show="shortcut.handler.enabled">
              <textarea x-data="editor" rows="1" x-model="shortcut.handler.code" :disabled="shortcut.enabled" spellcheck="false" autocapitalize="off" autocorrect="off" @input="adjustHeight()" @keydown="captureTab()"></textarea>
            </div>

            <!-- Toggle/Trigger/Duplicate/Delete -->
            <div class="grid">

              <!-- Toggle -->
              <button x-text="shortcut.enabled ? 'Disable' : 'Enable'" :class="shortcut.enabled ? 'secondary' : 'darkgreen'" :disabled="!isValidRequestBody(shortcut.params.body)" @click="status=await toggleShortcut(shortcut)"></button>

              <!-- Busy trigger -->
              <button x-data="busyButton" x-model="busy" :class="busy ? 'secondary' : 'darkgreen'" :aria-busy="busy" :disabled="!isValidRequestBody(shortcut.params.body) || busy" @click="busyWhile(() => triggerShortcut(shortcut).then(content => $store.responseModal.open(content)))">Trigger</button>

              <!-- Duplicate -->
              <button @click="duplicateShortcut(shortcut)">Duplicate</button>

              <!-- 2-step delete -->
              <button x-data="twoStepButton" x-text="waiting ? 'Confirm' : 'Delete'" class="darkred" @click="waitConfirmation(() => deleteShortcut(shortcutIndex))"></button>
            </div>

          </details>
        </article>
      </template>

      <!-- Create new shortcut -->
      <button class="darkgreen" @click="createShortcut()">New shortcut</button>
    </main>
  </div>

  <!-- Modals -->

  <!-- Settings -->
  <dialog open x-cloak x-show="$store.settingsModal.isOpen" x-transition @close-modal="$store.settingsModal.close()" @keydown.escape.window="$dispatch('close-modal')">

    <article>
      <header>
        <span class="bigger">Settings</span>
      </header>

      <!-- Server settings -->
      <h4>Home Assistant server</h4>

      <!-- Protocol/Host -->
      <div class="grid-1-4">

        <!-- Protocol -->
        <div class="grid-1-4-1">
          <label>Protocol</label>
          <select x-model="server.protocol">
            <option value="http">HTTP</option>
            <option value="https">HTTPS</option>
          </select>
        </div>

        <!-- Hostname -->
        <div class="grid-1-4-2">
          <label>Hostname</label>
          <input type="text" x-model="server.hostname">
        </div>
      </div>

      <!-- Port -->
      <label>Port</label>
      <input type="text" x-model="server.port">

      <!-- TdidEnableen -->
      <label>Long-lived access token</label>
      <input type="text" x-model="server.token">

      <!-- Appearence settings -->
      <h4>Appearence</h4>

      <label>
        <input type="checkbox" role="switch" name="darkTheme" x-model="darkTheme" @click="toggleDarkTheme()">
        Dark theme
      </label>
      <br />

      <!-- User config file settings -->
      <h4>Configuration file</h4>

      <label>
        <input type="checkbox" role="switch" name="autoSave" x-model="autoSave" @click="toggleAutoSave()">
        Auto save
      </label>
      <small>Runs on shortcut creation, deletion and toggle</small>
      <br />
      <br />
      <div class="grid">
        <button @click="initialize()">Reload</button>
        <button @click="openUserConfig()">Open</button>
      </div>

      <footer>
        <div class="grid">
          <button class="secondary" @click="$dispatch('close-modal')">Close without saving</button>
          <button class="darkgreen" @click="saveUserConfig().then($dispatch('close-modal'))">Save and close</button>
        </div>
      </footer>
    </article>
  </dialog>

  <!-- About -->
  <dialog open x-cloak x-show="$store.aboutModal.isOpen" x-transition @close-modal="$store.aboutModal.close()" @keydown.escape.window="$dispatch('close-modal')">
    <article>
      <header>
        <span class="bigger">About</span>
      </header>

      <img id="icon-bigger" />
      <br />
      <br />
      <p>
        Positron <span x-text="getAppVersion"></span><br />
        Create keyboard shortcuts for Home Assistant actions.
      </p>
      <p>
        For more information about this application contact:<br />
        Agustín Mista (agustin@mista.me)
      </p>
      <p>
        Useful links:<br />
      <div class="grid">
        <button class="secondary" @click="openExternal('https://github.com/agustinmista/positron')">Positron webpage</button>
        <button class="secondary" @click="openExternal('https://github.com/agustinmista/positron/issues')">Report issues</button>
        <button class="secondary" @click="openExternal('https://www.home-assistant.io')">Home Assistant</button>
      </div>
      </p>

      <footer>
        <button class="darkgreen" @click="$dispatch('close-modal')">Close</button>
      </footer>
    </article>
  </dialog>

  <!-- Response -->
  <dialog open x-cloak x-show="$store.responseModal.isOpen" x-transition @close-modal="$store.responseModal.close()" @keydown.escape.window="$dispatch('close-modal')">
    <article>
      <header>
        <span class="bigger">Response</span>
      </header>
      <span x-html="$store.responseModal.data"></span>
      <footer>
        <button class="darkgreen" @click="$dispatch('close-modal')">Close</button>
      </footer>
    </article>
  </dialog>

</body>

</html>